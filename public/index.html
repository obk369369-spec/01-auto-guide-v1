<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>1번 고객 자동화 안내서 · Auto Guide v1 (엑셀 입력 버전)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- 엑셀 파싱용 라이브러리 (SheetJS) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #f5f5f5;
      line-height: 1.5;
    }
    h1, h2, h3 {
      margin: 0 0 8px;
    }
    .container {
      max-width: 960px;
      margin: 0 auto;
      background: #ffffff;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    .section {
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px solid #e0e0e0;
    }
    label {
      display: block;
      margin-bottom: 4px;
      font-weight: 600;
    }
    input[type="file"],
    select,
    textarea,
    input[type="text"],
    input[type="email"],
    input[type="tel"],
    input[type="number"],
    input[type="date"] {
      width: 100%;
      box-sizing: border-box;
      padding: 6px 8px;
      margin-bottom: 8px;
      border-radius: 4px;
      border: 1px solid #cccccc;
      font-size: 14px;
    }
    button {
      cursor: pointer;
      padding: 6px 12px;
      border-radius: 4px;
      border: none;
      font-size: 14px;
      margin-right: 6px;
    }
    button.primary {
      background: #1976d2;
      color: #ffffff;
    }
    button.secondary {
      background: #eeeeee;
      color: #333333;
    }
    button.danger {
      background: #e53935;
      color: #ffffff;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    small {
      color: #666666;
      font-size: 12px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 13px;
    }
    th, td {
      border: 1px solid #dddddd;
      padding: 4px 6px;
      text-align: left;
      vertical-align: top;
    }
    th {
      background: #f0f0f0;
      font-weight: 600;
    }
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      background: #eeeeee;
      margin-right: 4px;
    }
    .badge.ok {
      background: #c8e6c9;
    }
    .badge.warn {
      background: #fff9c4;
    }
    .badge.err {
      background: #ffcdd2;
    }
    .flex {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    .flex-between {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
    }
    .mt-4 { margin-top: 4px; }
    .mt-8 { margin-top: 8px; }
    .mt-12 { margin-top: 12px; }
    .mt-16 { margin-top: 16px; }
    .text-muted { color: #666666; font-size: 13px; }
    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eeeeee;
      font-size: 11px;
      margin-left: 4px;
    }
    pre {
      background: #fafafa;
      border-radius: 4px;
      padding: 8px;
      white-space: pre-wrap;
      word-break: break-all;
      border: 1px solid #e0e0e0;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>1번 고객 자동화 안내서 · Auto Guide (엑셀 입력 v1)</h1>
    <div class="text-muted">
      오프라인·온라인 고객 데이터를 바탕으로 고객별 안내 메일 초안을 만드는 도구입니다.<br>
      <b>지금 버전은 엑셀 입력·파싱·목록 표시까지</b> 동작하고, 나머지 단계는 이후 모듈로 추가됩니다.
    </div>

    <!-- 0. 상태 요약 -->
    <div class="section">
      <div class="flex-between">
        <div>
          <strong>모듈 상태</strong><br />
          <span class="badge ok" id="status-excel">엑셀 파서: 대기</span>
          <span class="badge" id="status-storage">저장: 초기화</span>
        </div>
        <div class="text-muted">
          이 화면은 <b>엑셀 업로드 → 파싱 → 표 표시 → 브라우저 저장</b> 모듈만 포함합니다.
        </div>
      </div>
    </div>

    <!-- 1. 엑셀 데이터 입력 -->
    <div class="section">
      <h2>① 고객 데이터 입력 (엑셀 파일)</h2>
      <p class="text-muted">
        아래 형식의 엑셀 파일을 선택하면, 첫 번째 시트를 읽어 표로 보여 줍니다.<br>
        <b>열 이름 예시:</b> 기관, 고객이름, 이메일 주소, 유선전화번호, 스마트폰 번호, 연구비, 관심분야, 연구분야
      </p>
      <label for="excelFile">엑셀 파일 선택 (XLS / XLSX / CSV)</label>
      <input id="excelFile" type="file" accept=".xlsx,.xls,.csv" />
      <div class="mt-8">
        <button class="primary" id="btnParseExcel">엑셀에서 고객 목록 불러오기</button>
        <button class="secondary" id="btnLoadFromStorage">저장된 고객 목록 불러오기</button>
        <button class="danger" id="btnClearAll">모든 고객 데이터 삭제</button>
      </div>
      <div class="mt-4 text-muted">
        · 엑셀에서 불러온 데이터는 이 브라우저(localStorage)에만 저장됩니다.<br>
        · 도구가 만든 추가 열은, 나중에 기존 열의 오른쪽에 붙이는 방식으로 확장할 예정입니다.
      </div>
    </div>

    <!-- 2. 고객 목록 표시 -->
    <div class="section">
      <h2>② 고객 목록 확인</h2>
      <div class="flex-between">
        <div>
          <span class="pill" id="customerCountPill">고객 수: 0명</span>
        </div>
        <div class="text-muted">
          엑셀에서 읽은 고객 데이터가 표로 표시됩니다.
        </div>
      </div>
      <div class="mt-8" id="customerTableWrapper">
        <div class="text-muted">아직 불러온 고객 데이터가 없습니다.</div>
      </div>
    </div>

    <!-- 3. 안내서 생성·사후 조치 모듈 자리 (추후 모듈로 추가) -->
    <div class="section">
      <h2>③ 안내서 생성 / 사후 조치 (다음 모듈에서 추가)</h2>
      <div class="text-muted">
        이 버전에서는 엑셀 입력·파싱·목록 표시 모듈만 포함합니다.<br>
        안내 메일 초안 생성, 메일 발송 연동, 사후 조치 관리 모듈은 다음 단계에서 이어서 붙입니다.
      </div>
    </div>

    <!-- 디버그용 상태 -->
    <div class="section">
      <h3>디버그 정보 (간단)</h3>
      <pre id="debugArea">엑셀 모듈이 준비되었습니다.</pre>
    </div>
  </div>

  <script>
    // 공통 상수: 열 이름 정의
    const BASE_COLUMNS = [
      "기관",
      "고객이름",
      "이메일 주소",
      "유선전화번호",
      "스마트폰 번호",
      "연구비",
      "관심분야",
      "연구분야"
    ];
    const STORAGE_KEY = "auto_guide_customers_v1";

    const excelFileInput = document.getElementById("excelFile");
    const btnParseExcel = document.getElementById("btnParseExcel");
    const btnLoadFromStorage = document.getElementById("btnLoadFromStorage");
    const btnClearAll = document.getElementById("btnClearAll");
    const customerTableWrapper = document.getElementById("customerTableWrapper");
    const customerCountPill = document.getElementById("customerCountPill");
    const debugArea = document.getElementById("debugArea");
    const statusExcel = document.getElementById("status-excel");
    const statusStorage = document.getElementById("status-storage");

    function setDebug(message) {
      debugArea.textContent = message;
    }

    function setExcelStatus(text, cls) {
      statusExcel.textContent = text;
      statusExcel.className = "badge " + (cls || "");
    }

    function setStorageStatus(text, cls) {
      statusStorage.textContent = "저장: " + text;
      statusStorage.className = "badge " + (cls || "");
    }

    function saveCustomers(customers) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(customers));
        setStorageStatus("저장 완료", "ok");
      } catch (e) {
        setStorageStatus("저장 오류", "err");
        setDebug("저장 중 오류: " + e.message);
      }
    }

    function loadCustomers() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return [];
      try {
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed)) return parsed;
      } catch (_) {}
      return [];
    }

    function renderCustomerTable(customers) {
      if (!customers || customers.length === 0) {
        customerTableWrapper.innerHTML = '<div class="text-muted">표시할 고객 데이터가 없습니다.</div>';
        customerCountPill.textContent = "고객 수: 0명";
        return;
      }

      customerCountPill.textContent = "고객 수: " + customers.length + "명";

      // 실제 열 이름은 첫 번째 행의 키를 기준으로 결정
      const allKeysSet = new Set();
      customers.forEach(row => {
        Object.keys(row || {}).forEach(k => allKeysSet.add(k));
      });

      // BASE_COLUMNS 순서를 우선 적용하고, 나머지 열은 오른쪽에 추가
      const allKeys = [];
      BASE_COLUMNS.forEach(col => {
        if (allKeysSet.has(col)) allKeys.push(col);
      });
      allKeysSet.forEach(k => {
        if (!allKeys.includes(k)) allKeys.push(k);
      });

      let html = "<table><thead><tr>";
      allKeys.forEach(k => {
        html += "<th>" + k + "</th>";
      });
      html += "</tr></thead><tbody>";

      customers.forEach(row => {
        html += "<tr>";
        allKeys.forEach(k => {
          const val = row && row[k] != null ? String(row[k]) : "";
          html += "<td>" + escapeHtml(val) + "</td>";
        });
        html += "</tr>";
      });

      html += "</tbody></table>";
      customerTableWrapper.innerHTML = html;
    }

    function escapeHtml(str) {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
    }

    function parseExcelFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const data = e.target.result;
            const workbook = XLSX.read(data, { type: "array" });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const json = XLSX.utils.sheet_to_json(worksheet, { defval: "" });
            resolve(json);
          } catch (err) {
            reject(err);
          }
        };
        reader.onerror = function(e) {
          reject(e);
        };
        reader.readAsArrayBuffer(file);
      });
    }

    btnParseExcel.addEventListener("click", async function() {
      const file = excelFileInput.files && excelFileInput.files[0];
      if (!file) {
        alert("엑셀 파일을 먼저 선택해 주세요.");
        return;
      }
      setExcelStatus("읽는 중...", "warn");
      setDebug("엑셀 파일을 읽는 중입니다: " + file.name);

      try {
        const rows = await parseExcelFile(file);
        // rows는 [{열1:값1, 열2:값2, ...}, ...] 형태
        setExcelStatus("읽기 완료", "ok");
        setDebug("엑셀에서 " + rows.length + "명의 고객을 불러왔습니다.");
        saveCustomers(rows);
        renderCustomerTable(rows);
      } catch (err) {
        setExcelStatus("읽기 오류", "err");
        setDebug("엑셀 파싱 오류: " + err.message);
        alert("엑셀 파일을 읽는 중 오류가 발생했습니다.");
      }
    });

    btnLoadFromStorage.addEventListener("click", function() {
      const customers = loadCustomers();
      if (!customers.length) {
        alert("저장된 고객 데이터가 없습니다.");
        renderCustomerTable([]);
        return;
      }
      setStorageStatus("불러오기 완료", "ok");
      setDebug("저장된 고객 데이터 " + customers.length + "명을 불러왔습니다.");
      renderCustomerTable(customers);
    });

    btnClearAll.addEventListener("click", function() {
      if (!confirm("모든 고객 데이터를 삭제할까요? 이 브라우저에서만 삭제됩니다.")) return;
      localStorage.removeItem(STORAGE_KEY);
      renderCustomerTable([]);
      setStorageStatus("비어 있음", "");
      setDebug("모든 고객 데이터를 삭제했습니다.");
    });

    // 초기 로딩 시 저장 상태만 체크
    (function init() {
      const customers = loadCustomers();
      if (customers.length > 0) {
        setStorageStatus("기존 데이터 " + customers.length + "명", "ok");
        renderCustomerTable(customers);
        setDebug("기존 저장 데이터를 자동으로 불러왔습니다.");
      } else {
        setStorageStatus("비어 있음", "");
        setDebug("엑셀 모듈이 준비되었습니다. 파일을 선택한 뒤 ‘엑셀에서 고객 목록 불러오기’를 눌러 주세요.");
      }
    })();
  </script>
</body>
</html>
