<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>01 · CSV 필드 매핑 v1</title>
</head>
<body>
  <div id="status" style="font:14px system-ui; margin:8px 0;">JS: OK | STATE: INPUT | TEST: X</div>

  <textarea id="raw" placeholder="CSV 또는 텍스트를 그대로 붙여넣기" style="width:100%; height:140px; font:14px system-ui;"></textarea>

  <div style="margin:8px 0;">
    <button id="run">실행</button>
    <button id="reset">초기화</button>
    <button id="test">자동 테스트 1회</button>
  </div>

  <pre id="out" style="white-space:pre-wrap; border:1px solid #ccc; padding:10px; min-height:120px;">—</pre>

<script>
(() => {
  const LS_KEY = "wic_tool01_v5";
  const $ = (id) => document.getElementById(id);

  const st = {
    state: "INPUT",
    test: "X",
    lastAction: "BOOT",
    raw: "",
    out: "—",
    updatedAt: ""
  };

  function nowKST() {
    const d = new Date();
    const pad = (n) => String(n).padStart(2, "0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }

  function save() {
    st.updatedAt = nowKST();
    localStorage.setItem(LS_KEY, JSON.stringify(st));
  }

  function load() {
    try {
      const s = localStorage.getItem(LS_KEY);
      if (!s) return false;
      const obj = JSON.parse(s);
      if (!obj || typeof obj !== "object") return false;
      Object.assign(st, obj);
      return true;
    } catch { return false; }
  }

  function setStatus() {
    const js = "OK";
    $("status").textContent = `JS: ${js} | STATE: ${st.state} | TEST: ${st.test}`;
  }

  function splitLine(line) {
    // delimiter: comma 우선, 없으면 tab, 없으면 semicolon, 없으면 그냥 전체 1열
    const hasComma = line.includes(",");
    const hasTab = line.includes("\t");
    const hasSemi = line.includes(";");
    const delim = hasComma ? "," : (hasTab ? "\t" : (hasSemi ? ";" : null));
    if (!delim) return [line];
    return line.split(delim).map(s => s.trim());
  }

  function normalize(s) {
    return (s || "").toString().trim().toLowerCase().replace(/\s+/g, "");
  }

  function mapFields(headers, row) {
    // 우리가 원하는 필드(표준)
    const wanted = [
      { key:"기관",     aliases:["기관","소속","company","organization","org","institution"] },
      { key:"고객명",   aliases:["고객명","성명","이름","name","customername","contactname"] },
      { key:"관심분야", aliases:["관심분야","관심","interest","interests","keyword","키워드","주제","topic"] },
      { key:"연구분야", aliases:["연구분야","연구","field","researchfield","분야"] },
      { key:"예산",     aliases:["예산","budget","연구비","금액","amount","price"] },
      { key:"핸드폰",   aliases:["핸드폰","휴대폰","mobile","cell","phone","hp"] },
      { key:"유선",     aliases:["유선","전화","tel","telephone","officephone"] },
      { key:"이메일1",  aliases:["이메일","email","e-mail","메일","email1"] },
      { key:"이메일2",  aliases:["이메일2","email2","subemail","추가이메일","secondaryemail"] }
    ];

    const hNorm = headers.map(h => normalize(h));
    const result = {};
    // 1) 헤더 기반 매핑
    wanted.forEach(w => {
      let idx = -1;
      for (let i = 0; i < hNorm.length; i++) {
        const hn = hNorm[i];
        if (w.aliases.some(a => hn === normalize(a) || hn.includes(normalize(a)))) { idx = i; break; }
      }
      if (idx >= 0) result[w.key] = row[idx] ?? "";
      else result[w.key] = "";
    });

    // 2) 헤더가 의미 없거나(1열뿐 등) 전부 비면: “고정 순서” fallback
    const filled = Object.values(result).some(v => (v || "").trim().length > 0);
    if (!filled) {
      const order = ["기관","고객명","관심분야","연구분야","예산","핸드폰","유선","이메일1","이메일2"];
      for (let i = 0; i < order.length; i++) result[order[i]] = row[i] ?? "";
    }

    return result;
  }

  function buildOutputFromRaw(rawText) {
    const raw = (rawText || "").replace(/\r\n/g, "\n");
    const lines = raw.split("\n").filter(l => l.trim().length > 0);

    let header = [];
    let firstRow = [];
    let rows = 0;
    let cols = 0;

    if (lines.length >= 1) header = splitLine(lines[0]);
    if (lines.length >= 2) firstRow = splitLine(lines[1]);

    cols = header.length || (firstRow.length || 0);

    // 데이터행 개수(헤더 제외)
    rows = Math.max(0, lines.length - 1);

    const mapped = mapFields(header, firstRow);

    const previewCount = Math.min(5, rows);
    const preview = [];
    for (let i = 0; i < previewCount; i++) {
      const r = splitLine(lines[i+1] || "");
      preview.push(r.join(" | "));
    }

    const rawChars = raw.trim().length;
    const firstLine = (raw.split("\n")[0] || "").trim() || "-";
    const excerpt = raw.trim().slice(0, 300) || "-";
    const wordCount = raw.trim().length ? raw.trim().split(/\s+/).filter(Boolean).length : 0;

    const outText =
`CSV 미리보기
time: ${nowKST()}
columns: ${cols}
rows: ${rows}

header:
${header.join(" | ") || "-"}

mapped(첫 데이터행 → 필드):
기관: ${mapped["기관"] || "-"}
고객명: ${mapped["고객명"] || "-"}
관심분야: ${mapped["관심분야"] || "-"}
연구분야: ${mapped["연구분야"] || "-"}
예산: ${mapped["예산"] || "-"}
핸드폰: ${mapped["핸드폰"] || "-"}
유선: ${mapped["유선"] || "-"}
이메일1: ${mapped["이메일1"] || "-"}
이메일2: ${mapped["이메일2"] || "-"}

preview(${previewCount}):
${preview.length ? preview.map(x => "- " + x).join("\n") : "-"}

raw_chars: ${rawChars}
word_count: ${wordCount}
first_line: ${firstLine}
excerpt(300): ${excerpt}`;

    return outText;
  }

  function applyToUI() {
    $("raw").value = st.raw || "";
    $("out").textContent = st.out || "—";
    setStatus();
  }

  // BOOT
  if (load()) {
    applyToUI();
    st.lastAction = "RESTORE";
    save();
  } else {
    setStatus();
    save();
  }

  $("run").addEventListener("click", () => {
    st.raw = $("raw").value || "";
    st.out = buildOutputFromRaw(st.raw);
    st.state = "GUIDE";
    st.test = "X";
    st.lastAction = "RUN";
    save();
    applyToUI();
  });

  $("reset").addEventListener("click", () => {
    st.raw = "";
    st.out = "—";
    st.state = "INPUT";
    st.test = "X";
    st.lastAction = "RESET";
    save();
    applyToUI();
  });

  $("test").addEventListener("click", () => {
    // PASS 조건: GUIDE 상태 + out에 mapped(첫 데이터행 → 필드) 포함 + localStorage 저장됨
    const hasBundle = !!localStorage.getItem(LS_KEY);
    const ok =
      st.state === "GUIDE" &&
      typeof st.out === "string" &&
      st.out.includes("mapped(첫 데이터행 → 필드):") &&
      hasBundle;

    st.test = ok ? "PASS" : "FAIL";
    st.lastAction = "TEST";
    save();
    setStatus();
  });
})();
</script>
</body>
</html>
